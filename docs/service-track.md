# 微服务-推广与跟踪系统 `track`

## 介绍

- 用于用户推广跟踪记录

## 数据库

<!-- ### 推广码表 `track`

| KEY        | TYPE        | DEFAULT | NOT NULL | INCREMENT | PRIMARY | FOREIGN | REMARK |     |
|------------|-------------|---------|----------|-----------|---------|---------|--------|-----|
| id         | INT         |         | Y        | Y         | Y       |         |        |     |
| track_type | INT         |         | Y        |           |         |         |        |     |
| user_id    | INT         |         | Y        |           |         | Y       |        |     |
| referrer   | INT         |         |          |           |         | Y       |        |     |
| promcode   | VARCHAR(64) |         | Y        |           |         |         |        | --> |

### 推广码表 `promo`

| KEY        | TYPE         | DEFAULT | NOT NULL | INCREMENT | PRIMARY | FOREIGN | REMARK         |
|------------|--------------|---------|----------|-----------|---------|---------|----------------|
| id         | INT          |         | Y        | Y         | Y       |         |                |
| user_id    | INT          |         | Y        |           |         | Y       |                |
| promo_type | INT          | 1       | Y        |           |         |         |                |
| appid      | VARCHAR(32)  |         |          |           |         |         |                |
| promocode  | VARCHAR(64)  |         | Y        |           |         |         | 全表唯一，考虑hashids |
| wxbcode    | VARCHAR(255) |         |          |           |         |         |                |
| page       | VARCHAR(255) |         |          |           |         |         |                |

```js
promo_type: {
  1: `小程序推广`, // 默认
}
```

### 推广码跟踪表 `track`

| KEY        | TYPE         | DEFAULT | NOT NULL | INCREMENT | PRIMARY | FOREIGN | REMARK |
|------------|--------------|---------|----------|-----------|---------|---------|--------|
| id         | INT          |         | Y        | Y         | Y       |         |        |
| track_type | INT          |         | Y        |           |         |         |        |
| scene      | VARCHAR(32)  |         | Y        |           |         |         |        |
| detail     | VARCHAR(128) |         |          |           |         |         |        |
| user_id    | INT          |         | Y        |           |         | Y       | 上报用户   |
| promocode  | VARCHAR(64)  |         | Y        |           |         |         | 来源推广码  |

```js
track_type: {
  1: `新用户访问`,
  2: `老用户访问`,
}
// 对应 小程序 的 scene
scene {
1001: 发现栏小程序主入口
1005: 顶部搜索框的搜索结果页
1006: 发现栏小程序主入口搜索框的搜索结果页
1007: 单人聊天会话中的小程序消息卡片
1008: 群聊会话中的小程序消息卡片
1011: 扫描二维码
1012: 长按图片识别二维码
1013: 手机相册选取二维码
1014: 小程序模版消息
1017: 前往体验版的入口页
1019: 微信钱包
1020: 公众号 profile 页相关小程序列表
1022: 聊天顶部置顶小程序入口
1023: 安卓系统桌面图标
1024: 小程序 profile 页
1025: 扫描一维码
1026: 附近小程序列表
1027: 顶部搜索框搜索结果页“使用过的小程序”列表
1028: 我的卡包
1029: 卡券详情页
1030: 自动化测试下打开小程序
1031: 长按图片识别一维码
1032: 手机相册选取一维码
1034: 微信支付完成页
1035: 公众号自定义菜单
1036: App 分享消息卡片
1037: 小程序打开小程序
1038: 从另一个小程序返回
1039: 摇电视
1042: 添加好友搜索框的搜索结果页
1043: 公众号模板消息
1044: 带 shareTicket 的小程序消息卡片（详情)
1047: 扫描小程序码
1048: 长按图片识别小程序码
1049: 手机相册选取小程序码
1052: 卡券的适用门店列表
1053: 搜一搜的结果页
1054: 顶部搜索框小程序快捷入口
1056: 音乐播放器菜单
1057: 钱包中的银行卡详情页
1058: 公众号文章
1059: 体验版小程序绑定邀请页
1064: 微信连Wi-Fi状态栏
1067: 公众号文章广告
1068: 附近小程序列表广告
1071: 钱包中的银行卡列表页
1072: 二维码收款页面
1073: 客服消息列表下发的小程序消息卡片
1074: 公众号会话下发的小程序消息卡片
1078: 连Wi-Fi成功页
1089: 微信聊天主界面下拉
1090: 长按小程序右上角菜单唤出最近使用历史
1092: 城市服务入口
}
```

### 转发表 `share`

| KEY        | TYPE         | DEFAULT | NOT NULL | INCREMENT | PRIMARY | FOREIGN | REMARK |
|------------|--------------|---------|----------|-----------|---------|---------|--------|
| id         | INT          |         | Y        | Y         | Y       |         |        |
| share_type | INT          |         |          |           |         |         |        |
| page       | VARCHAR(255) |         |          |           |         |         |        |
| user_id    | INT          |         |          |           |         | Y       |        |
| promocode  | VARCHAR(64)  |         |          |           |         |         |        |

```js
share_type {
  0: '未知',
  1: 'menu',
  2: 'button',
}
```

## API

### 获取推广码

- 没有则自动创建

```sh
GET /tracks/{user_id}/{promo_type}
```

Response

```js
{
  id: 13213,
  track_type: 1,
  user_id: 12323,
  referrer: 2342343,
  promcode: '2sdfsdasdwe',
}
```

### 添加推广记录

```sh
POST /tracks
```

Request

```js
{
  user_id: 6432434,
  track_type: 1,
  referrer: 1,
  user_id,
  promocode,
}
```